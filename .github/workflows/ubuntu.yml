name: Ubuntu RDP Fast

on:
  workflow_dispatch:

jobs:
  secure-rdp-ubuntu:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: 1. Install Desktop & RDP (XFCE)
        run: |
          sudo apt-get update
          # Install XFCE (Lightweight GUI) and XRDP server
          sudo apt-get install -y xfce4 xfce4-goodies xrdp

          # Configure XRDP to start XFCE
          sudo sed -i.bak '/fi/a #xrdp multiple users configuration \n xfce4-session \n' /etc/xrdp/startwm.sh
          
          # Enable and start the RDP service
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: 2. Create User 'r'
        run: |
          # Create user 'r' with password 'Opopop1!'
          sudo useradd -m -s /bin/bash r
          echo "r:Opopop1!" | sudo chpasswd
          sudo usermod -aG sudo r
          
          # Force XFCE session for this user
          echo "xfce4-session" | sudo tee /home/r/.xsession
          sudo chown r:r /home/r/.xsession

      - name: 3. Install Brave Browser
        run: |
          sudo curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" | sudo tee /etc/apt/sources.list.d/brave-browser-release.list
          sudo apt-get update
          sudo apt-get install -y brave-browser

      - name: 4. Connect Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # --ephemeral is CRITICAL to prevent 'exit code 1' errors by auto-removing old devices
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-ubuntu-${{ github.run_id }} \
            --ephemeral \
            --ssh

          # Get the IP address
          IP=""
          count=0
          while [ -z "$IP" ] && [ $count -lt 10 ]; do
            IP=$(tailscale ip -4)
            sleep 5
            ((count++))
          done
          echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV

      - name: 5. Display Login Info
        run: |
          echo ""
          echo "=========================================="
          echo "   âœ… RDP READY - CONNECT NOW"
          echo "=========================================="
          echo "   IP Address : $TAILSCALE_IP"
          echo "   Username   : r"
          echo "   Password   : Opopop1!"
          echo "=========================================="
          echo ""
          
          # Keep the runner alive
          while true; do
            sleep 300
          done
