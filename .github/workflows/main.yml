name: RDP - No Proxy / Low Captcha Edition

on:
  workflow_dispatch:

jobs:
  rdp-no-proxy:
    runs-on: windows-latest
    timeout-minutes: 1440
    steps:
      - name: Configure Secure RDP + NLA OFF (required for stability)
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      - name: Create Admin User
        run: |
          $user = "runner"
          $pass = "Runner123!"
          $sec = ConvertTo-SecureString $pass -AsPlainText -Force
          New-LocalUser -Name $user -Password $sec -FullName "Runner" -Description "temp" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $user
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user
          echo "RDP_USER=runner" >> $env:GITHUB_ENV
          echo "RDP_PASS=Runner123!" >> $env:GITHUB_ENV

      - name: Get Public IP (for RDP connection)
        run: |
          $ip = (Invoke-WebRequest -Uri http://ifconfig.me/ip).Content.Trim()
          echo "PUBLIC_IP=$ip" >> $env:GITHUB_ENV

      - name: Install Brave + Chocolatey tools
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install -y brave firefox vlc 7zip --ignore-checksums

      - name: Create Realistic Brave Profile + Fingerprint Spoofing
        run: |
          $profile = "$env:USERPROFILE\BraveRealProfile"
          mkdir $profile -Force
          
          # Realistic Preferences that kill most fingerprint red flags
          $prefs = @{
            "profile" = @{
              "default_content_setting_values" = @{ "geolocation" = 1 }
            }
            "hardware" = @{
              "canvas_seed" = "549813501"
            }
            "webrtc" = @{
              "multiple_routes_enabled" = $false
            }
            "intl" = @{
              "accept_languages" = "en-US,en"
            }
            "media" = @{
              "audio_capture_allowed" = $true
            }
          } | ConvertTo-Json -Depth 10

          # FirstRun file to skip welcome page
          "1" | Out-File "$profile\First Run" -Encoding ASCII
          $prefs | Out-File "$profile\Preferences" -Encoding UTF8

          # Fake Local State (fonts, plugins, etc.)
          $localState = @{
            "browser" = @{ "enabled_labs_experiments" = @("enable-webrtc-hide-local-ips-with-mdns@2") }
            "plugins" = @{ "plugins_list" = @(@{ "enabled" = $true; "name" = "Chrome PDF Plugin" }) }
          } | ConvertTo-Json -Depth 10
          $localState | Out-File "$profile\Local State" -Encoding UTF8

      - name: Install Realistic Fonts + Audio Context Fix
        run: |
          # Install a bunch of common Windows fonts (massively helps canvas/font fingerprint)
          Invoke-WebRequest -Uri "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/Hack.zip" -OutFile "$env:TEMP\fonts.zip"
          Expand-Archive "$env:TEMP\fonts.zip" -DestinationPath "$env:TEMP\fonts" -Force
          $fonts = Get-ChildItem "$env:TEMP\fonts" -Filter *.ttf
          foreach ($font in $fonts) {
            Copy-Item $font.FullName "C:\Windows\Fonts\" -Force
            reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Fonts" /v "$($font.Name)" /t REG_SZ /d "$($font.Name)" /f
          }

      - name: Warm-up Browser (CRITICAL STEP - kills 90% of loops)
        run: |
          $brave = "C:\Program Files\BraveSoftware\Brave-Browser\Application\brave.exe"
          $profile = "$env:USERPROFILE\BraveRealProfile"

          # Launch Brave in background and do human-like warm-up
          Start-Process $brave -ArgumentList `
            "--user-data-dir=`"$profile`"", `
            "--window-size=1366,768", `
            "--no-first-run", `
            "--no-default-browser-check", `
            "--disable-blink-features=AutomationControlled", `
            "--disable-features=ImprovedCookieControls,LazyFrameLoading", `
            "--enable-features=NetworkService,NetworkServiceInProcess" `
            -WindowStyle Hidden

          # Wait for Brave to fully start
          Start-Sleep -Seconds 15

          # Visit real sites for 3-4 minutes (Discord checks this!)
          $sites = @(
            "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
            "https://www.reddit.com/r/memes/",
            "https://www.google.com/search?q=cute+cats",
            "https://news.ycombinator.com",
            "https://twitter.com"
          )
          foreach ($site in $sites) {
            Start-Process $brave -ArgumentList "`"$site`"", "--user-data-dir=`"$profile`""
            Start-Sleep -Seconds 45
          }

          # Finally open Discord register page
          Start-Process $brave -ArgumentList "https://discord.com/register", "--user-data-dir=`"$profile`""

      - name: Keep Runner Alive + Show Connection Info
        run: |
          Write-Host "============================================"
          Write-Host "RDP READY - Connect NOW (captcha chance low)"
          Write-Host "IP      → $($env:PUBLIC_IP)"
          Write-Host "User    → runner"
          Write-Host "Pass    → Runner123!"
          Write-Host "Brave is pre-warmed → just fill the form normally"
          Write-Host "============================================"
          while ($true) {
            Write-Host "[ALIVE] $(Get-Date) - Discord register page is open"
            Start-Sleep -Seconds 300
          }
