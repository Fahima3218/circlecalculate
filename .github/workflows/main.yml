name: RDP
on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Configure Core RDP
        run: |
          # 1. Enable RDP connectivity and security settings
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # 2. Set Standard Desktop Resolution (1280x720)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "DefaultClientResolution" -Value 1280 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "DefaultClientColorDepth" -Value 32 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "DefaultClientHeight" -Value 720 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "DefaultClientWidth" -Value 1280 -Force
          
          # 3. Configure Firewall and Restart Service
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        run: |
          # Set the desired username and complex password
          $username = "R"
          $password = "Opopop1!"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          echo "RDP_CREDS=User: $username | Password: $password" >> $env:GITHUB_ENV

      - name: Install Cloudflare WARP
        run: |
          # Install Cloudflare WARP (Manual connect required after login)
          $url = "https://1111-releases.cloudflareclient.com/windows/Cloudflare_WARP_Release-x64.msi"
          $path = "$env:TEMP\warp.msi"
          Invoke-WebRequest -Uri $url -OutFile $path
          Start-Process msiexec.exe -ArgumentList "/i", "`"$path`"", "/quiet", "/norestart" -Wait
          Remove-Item $path -Force
          
          # Register the client
          & "$env:ProgramFiles\Cloudflare\Cloudflare WARP\warp-cli.exe" registration new

      - name: Install Brave Browser
        run: |
          # Clean installation of Brave
          $url = "https://brave-browser-downloads.s3.brave.com/latest/brave_installer-x64.exe"
          $installer = "$env:TEMP\brave_installer-x64.exe"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process -FilePath $installer -ArgumentList "--install","--silent","--system-level" -Wait
          Remove-Item $installer -Force

      - name: Humanize Environment
        run: |
          # 1. Install Common "Human" Software (Populates Registry)
          choco install vlc 7zip notepadplusplus -y --no-progress
          
          # 2. Install a Legitimate Font (Lato)
          $fontUrl = "https://github.com/google/fonts/raw/main/ofl/lato/Lato-Regular.ttf"
          $fontPath = "$env:TEMP\Lato-Regular.ttf"
          Invoke-WebRequest -Uri $fontUrl -OutFile $fontPath
          $shell = New-Object -ComObject Shell.Application
          $shell.Namespace(0x14).CopyHere($fontPath) # 0x14 is the Fonts folder

          # 3. Create Dummy "Work" Files (File System Fingerprint)
          $userPath = "C:\Users\R"
          New-Item -ItemType Directory -Force -Path "$userPath\Documents\Work_Projects"
          "Meeting notes for Q4" | Out-File "$userPath\Documents\Work_Projects\notes.txt"
          "Budget calculation draft" | Out-File "$userPath\Documents\Work_Projects\budget.csv"

          # 4. Generate the 'Auto-Search' Script for the RDP Desktop
          # When you login, double click this script to auto-browse sites.
          $scriptContent = @'
          Write-Host "=== WARMING UP BROWSER COOKIES & HISTORY ===" -ForegroundColor Cyan
          $brave = "$env:ProgramFiles\BraveSoftware\Brave-Browser\Application\brave.exe"
          
          # List of "Human" activities to perform
          $activities = @(
            "https://www.google.com/search?q=best+mechanical+keyboard+2024",
            "https://www.youtube.com/results?search_query=lofi+beats+to+study+to",
            "https://www.amazon.com/s?k=gaming+monitor+144hz",
            "https://en.wikipedia.org/wiki/Special:Random",
            "https://www.reddit.com/r/popular",
            "https://stackoverflow.com/questions/how-to-center-a-div",
            "https://www.nytimes.com",
            "https://discord.com/login"
          )
          
          foreach ($site in $activities) {
            Write-Host "Browsing: $site"
            Start-Process $brave -ArgumentList $site
            # Random sleep between 4 and 8 seconds to mimic reading
            Start-Sleep -Seconds (Get-Random -Minimum 4 -Maximum 8)
          }
          
          Write-Host "Warmup Complete. You may now attempt to register." -ForegroundColor Green
          Read-Host "Press Enter to exit..."
          '@
          
          $scriptContent | Out-File -FilePath "$userPath\Desktop\1_RUN_ME_FIRST.ps1" -Encoding ASCII

      - name: Install Tailscale
        run: |
          $url="https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installer="$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installer`"", "/quiet", "/norestart" -Wait
          Remove-Item $installer -Force

      - name: Connect Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          $ip=$null;$r=0
          while (-not $ip -and $r -lt 10) {
            $ip=& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            Start-Sleep 5
            $r++
          }
          if (-not $ip) { exit 1 }
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: Verify RDP
        run: |
          $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $test.TcpTestSucceeded) { exit 1 }

      - name: Keep Alive
        run: |
          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "IP: $env:TAILSCALE_IP"
          Write-Host "User: R"
          Write-Host "Password: $password"
          Write-Host "==================`n"
          while ($true) {
            Write-Host "[ACTIVE] $(Get-Date)"
            Start-Sleep 300
          }
