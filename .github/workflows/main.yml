name: RDP – Low-Captcha Discord (No Proxy)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 1440

    steps:
      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      - name: Create Unique Admin User (avoids conflicts)
        run: |
          $runId = $env:GITHUB_RUN_NUMBER
          $username = "rdpuser_$runId"
          $passwordPlain = "Abcd1234!@#$%"
          $Password = ConvertTo-SecureString $passwordPlain -AsPlainText -Force
          
          # No deletion needed - unique name per run
          New-LocalUser -Name $username -Password $Password -FullName "RDP User" -Description "GitHub RDP" -AccountNeverExpires:$true -PasswordNeverExpires:$true
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          Write-Host "Unique user $username created successfully."

      - name: Get Public IP + Show Credentials in Logs
        run: |
          $runId = $env:GITHUB_RUN_NUMBER
          $username = "rdpuser_$runId"
          $ip = (Invoke-WebRequest -Uri https://ipinfo.io/ip -UseBasicParsing).Content.Trim()
          Write-Host "=========================================="
          Write-Host "RDP READY – CONNECT NOW"
          Write-Host "IP       : $ip"
          Write-Host "Username : $username"
          Write-Host "Password : Abcd1234!@#$%"
          Write-Host "Brave is installed with realistic profile ready for manual use"
          Write-Host "=========================================="
          echo "RDP_IP=$ip" >> $env:GITHUB_ENV
          echo "RDP_USER=rdpuser_$runId" >> $env:GITHUB_ENV

      - name: Install Brave + Tools
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install -y brave --ignore-checksums

      - name: Create Realistic Brave Profile + Fingerprint Spoofing
        run: |
          $profilePath = "$env:USERPROFILE\BraveRealProfile"
          New-Item -ItemType Directory -Path $profilePath -Force

          # Skip first-run, spoof realistic values
          "1" | Out-File "$profilePath\First Run" -Encoding ASCII

          $prefs = @{
            "profile" = @{ "default_content_settings" = @{ "geolocation" = 1 } }
            "hardware" = @{ "canvas_seed" = "981723546" }
            "webrtc" = @{ "multiple_routes_enabled" = $false }
            "intl" = @{ "accept_languages" = "en-US,en" }
          } | ConvertTo-Json -Depth 10
          $prefs | Out-File "$profilePath\Preferences" -Encoding UTF8

      - name: Install Common Fonts (helps canvas/font fingerprint)
        run: |
          iwr "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/Hack.zip" -OutFile "$env:TEMP\fonts.zip"
          Expand-Archive "$env:TEMP\fonts.zip" -DestinationPath "$env:TEMP\fonts" -Force
          $fonts = Get-ChildItem "$env:TEMP\fonts\*.ttf"
          $fontReg = 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Fonts'
          foreach ($f in $fonts) {
            Copy-Item $f.FullName "C:\Windows\Fonts\" -Force
            New-ItemProperty -Path $fontReg -Name $f.Name -PropertyType String -Value $f.Name -Force | Out-Null
          }

      - name: Keep Alive (shows status every 5 min)
        run: |
          $runId = $env:GITHUB_RUN_NUMBER
          $username = "rdpuser_$runId"
          while ($true) {
            Write-Host "[ALIVE] $(Get-Date) | IP: $($env:RDP_IP) | User: $username | Pass: Abcd1234!@#$%"
            Write-Host "Manual: Launch Brave from Start Menu, use 'BraveRealProfile' folder if needed"
            Start-Sleep -Seconds 300
          }
