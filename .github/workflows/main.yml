name: RDP – Low-Captcha Discord (No Proxy)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 1440

    steps:
      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      - name: Create RDP User (r / Opopop1!)
        run: |
          $username = "r"
          $password = "Opopop1!"
          
          # Delete if exists (using net user for reliability)
          net user $username /delete 2>$null
          
          # Create user
          net user $username $password /add /fullname:"RDP User" /expires:never
          net localgroup Administrators $username /add
          net localgroup "Remote Desktop Users" $username /add
          Write-Host "User $username created with password $password"

      - name: Get Public IP + Show Credentials in Logs
        run: |
          $username = "r"
          $password = "Opopop1!"
          $ip = (Invoke-WebRequest -Uri https://ipinfo.io/ip -UseBasicParsing).Content.Trim()
          Write-Host "=========================================="
          Write-Host "RDP READY – CONNECT NOW"
          Write-Host "IP       : $ip"
          Write-Host "Username : $username"
          Write-Host "Password : $password"
          Write-Host "=========================================="
          echo "RDP_IP=$ip" >> $env:GITHUB_ENV

      - name: Install Brave + Tools
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install -y brave --ignore-checksums

      - name: Create Realistic Brave Profile + Fingerprint Spoofing
        run: |
          $profilePath = "$env:USERPROFILE\BraveRealProfile"
          New-Item -ItemType Directory -Path $profilePath -Force

          # Skip first-run, spoof realistic values
          "1" | Out-File "$profilePath\First Run" -Encoding ASCII

          $prefs = @{
            "profile" = @{ "default_content_settings" = @{ "geolocation" = 1 } }
            "hardware" = @{ "canvas_seed" = "981723546" }
            "webrtc" = @{ "multiple_routes_enabled" = $false }
            "intl" = @{ "accept_languages" = "en-US,en" }
          } | ConvertTo-Json -Depth 10
          $prefs | Out-File "$profilePath\Preferences" -Encoding UTF8
          Write-Host "Realistic Brave profile created at $profilePath"

      - name: Install Common Fonts (helps canvas/font fingerprint)
        run: |
          iwr "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/Hack.zip" -OutFile "$env:TEMP\fonts.zip"
          Expand-Archive "$env:TEMP\fonts.zip" -DestinationPath "$env:TEMP\fonts" -Force
          $fonts = Get-ChildItem "$env:TEMP\fonts\*.ttf"
          $fontReg = 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Fonts'
          foreach ($f in $fonts) {
            Copy-Item $f.FullName "C:\Windows\Fonts\" -Force
            New-ItemProperty -Path $fontReg -Name $f.Name -PropertyType String -Value $f.Name -Force | Out-Null
          }
          Write-Host "Common fonts installed for better fingerprinting"

      - name: Keep Alive (shows status every 5 min)
        run: |
          $username = "r"
          $password = "Opopop1!"
          while ($true) {
            Write-Host "[ALIVE] $(Get-Date) | IP: $($env:RDP_IP) | User: $username | Pass: $password"
            Write-Host "Manual: Launch Brave from Start Menu, use 'BraveRealProfile' folder if needed"
            Start-Sleep -Seconds 300
          }
