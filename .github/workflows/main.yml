name: RDP – Low-Captcha Discord (No Proxy)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 1440

    steps:
      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      - name: Create Admin User (password policy compliant)
        run: |
          $Password = ConvertTo-SecureString "Abcd1234!@#$%" -AsPlainText -Force
          New-LocalUser -Name "runneradmin" -Password $Password -FullName "Runner" -Description "GitHub Runner RDP" -AccountNeverExpires:$true -PasswordNeverExpires:$true
          Add-LocalGroupMember -Group "Administrators" -Member "runneradmin"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "runneradmin"

      - name: Get Public IP + Show Credentials in Logs
        run: |
          $ip = (Invoke-WebRequest -Uri https://ifconfig.me -UseBasicParsing).Content.Trim()
          Write-Host "=========================================="
          Write-Host "RDP READY – CONNECT NOW"
          Write-Host "IP       : $ip"
          Write-Host "Username : runneradmin"
          Write-Host "Password : Abcd1234!@#$%"
          Write-Host "=========================================="
          echo "RDP_IP=$ip" >> $env:GITHUB_ENV

      - name: Install Brave + Tools
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install -y brave --ignore-checksums

      - name: Create Realistic Brave Profile + Fingerprint Spoofing
        run: |
          $profilePath = "$env:USERPROFILE\BraveRealProfile"
          New-Item -ItemType Directory -Path $profilePath -Force

          # Skip first-run, spoof realistic values
          "1" | Out-File "$profilePath\First Run" -Encoding ASCII

          $prefs = @{
            "profile" = @{ "default_content_settings" = @{ "geolocation" = 1 } }
            "hardware" = @{ "canvas_seed" = "981723546" }
            "webrtc" = @{ "multiple_routes_enabled" = $false }
            "intl" = @{ "accept_languages" = "en-US,en" }
          } | ConvertTo-Json -Depth 10
          $prefs | Out-File "$profilePath\Preferences" -Encoding UTF8

      - name: Install Common Fonts (helps canvas/font fingerprint)
        run: |
          iwr "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/Hack.zip" -OutFile "$env:TEMP\fonts.zip"
          Expand-Archive "$env:TEMP\fonts.zip" -DestinationPath "$env:TEMP\fonts" -Force
          $fonts = Get-ChildItem "$env:TEMP\fonts\*.ttf"
          $fontReg = 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Fonts'
          foreach ($f in $fonts) {
            Copy-Item $f.FullName "C:\Windows\Fonts\" -Force
            New-ItemProperty -Path $fontReg -Name $f.Name -PropertyType String -Value $f.Name -Force | Out-Null
          }

      - name: Warm-up Browser + Open Discord Register (MOST IMPORTANT)
        run: |
          $brave = "${env:ProgramFiles}\BraveSoftware\Brave-Browser\Application\brave.exe"
          $profile = "$env:USERPROFILE\BraveRealProfile"

          # Anti-detection flags
          $args = @(
            "--user-data-dir=`"$profile`"",
            "--window-size=1366,768",
            "--no-first-run",
            "--disable-blink-features=AutomationControlled",
            "--start-maximized"
          )

          # 1. Start Brave hidden first
          Start-Process $brave -ArgumentList $args -WindowStyle Hidden
          Start-Sleep -Seconds 18

          # 2. Warm-up phase – visit real sites (kills captcha loop)
          $warmup = @(
            "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
            "https://www.reddit.com/r/popular"
            "https://news.google.com"
            "https://twitter.com/explore"
          )
          foreach ($url in $warmup) {
            Start-Process $brave -ArgumentList $args, "`"$url`""
            Start-Sleep -Seconds 40
          }

          # 3. Finally open Discord register page
          Start-Process $brave -ArgumentList $args, "https://discord.com/register" -WindowStyle Normal
          Write-Host "Discord register page opened and pre-warmed – you will get 0 or 1 captcha max"

      - name: Keep Alive (shows status every 5 min)
        run: |
          while ($true) {
            Write-Host "[ALIVE] $(Get-Date) | IP: $($env:RDP_IP) | User: runneradmin | Pass: Abcd1234!@#$%"
            Start-Sleep -Seconds 300
          }
